<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Film Style Lab — v3.2 (필터 포함)</title>
  <meta name="theme-color" content="#111111" />
  <style>
    html,body{height:100%}
    body{margin:0;background:#f8fafc;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1fr 2fr 1fr;gap:16px}
    .bar{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:20;display:flex;align-items:center;padding:12px 16px}
    button,input[type=file]{appearance:none;border:1px solid #111;background:#111;color:#fff;border-radius:8px;padding:8px 12px;font-weight:600;margin-left:6px}
    button.ghost{background:#fff;color:#111}
    button:disabled{opacity:.5}
    canvas{border:1px solid #e5e7eb;border-radius:8px;max-width:100%;height:auto}
    .panel{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px;overflow:auto}
    .preset-btn{display:block;width:100%;margin:4px 0;padding:8px;border:1px solid #ddd;border-radius:6px;background:#fafafa;cursor:pointer;text-align:left}
    .preset-btn:hover{background:#eee}
    label.slider{display:block;margin:6px 0;font-size:12px}
  </style>
</head>
<body>
  <header class="bar">
    <strong style="font-size:16px">🎞️ Film Style Lab</strong>
    <div style="margin-left:auto;display:flex;align-items:center">
      <input id="file" type="file" accept="image/*,.jpg,.jpeg,.png,.webp" style="display:none" />
      <label for="file" class="ghost" style="cursor:pointer">사진 열기</label>
      <button id="openBtn" class="ghost">파일 선택</button>
      <input id="fileDirect" type="file" accept="image/*,.jpg,.jpeg,.png,.webp" />
      <button id="saveBtn" disabled>이미지 저장</button>
    </div>
  </header>

  <main class="container">
    <div class="panel">
      <h4>영화 스타일 프리셋</h4>
      <button class="preset-btn" data-filter="wes">Wes Anderson</button>
      <button class="preset-btn" data-filter="blade">Blade Runner 2049</button>
      <button class="preset-btn" data-filter="lala">La La Land</button>
      <button class="preset-btn" data-filter="matrix">Matrix</button>
      <button class="preset-btn" data-filter="her">Her</button>
    </div>

    <div class="panel" style="text-align:center">
      <canvas id="cv"></canvas>
    </div>

    <div class="panel">
      <h4>세부 조정</h4>
      <label class="slider">노출 <input type="range" id="exp" min="-100" max="100" value="0"></label>
      <label class="slider">대비 <input type="range" id="contrast" min="-100" max="100" value="0"></label>
      <label class="slider">채도 <input type="range" id="satur" min="-100" max="100" value="0"></label>
    </div>
  </main>

<script>
(function(){
  const cv=document.getElementById('cv');
  const ctx=cv.getContext('2d');
  let original=null;

  function draw(src){
    if(!src) return;
    const w=src.naturalWidth||src.width; const h=src.naturalHeight||src.height;
    cv.width=w; cv.height=h;
    ctx.drawImage(src,0,0,w,h);
  }

  function applyFilters(){
    if(!original) return;
    draw(original);
    const imgData=ctx.getImageData(0,0,cv.width,cv.height);
    const d=imgData.data;
    const exp=parseInt(document.getElementById('exp').value,10);
    const contrast=parseInt(document.getElementById('contrast').value,10);
    const satur=parseInt(document.getElementById('satur').value,10);

    // precompute contrast factor
    const factor=(259*(contrast+255))/(255*(259-contrast));

    for(let i=0;i<d.length;i+=4){
      let r=d[i], g=d[i+1], b=d[i+2];

      // exposure (simple add; clamp later)
      r+=exp; g+=exp; b+=exp;

      // contrast
      r=factor*(r-128)+128;
      g=factor*(g-128)+128;
      b=factor*(b-128)+128;

      // saturation
      const avg=(r+g+b)/3;
      const s=1+satur/100;
      r=avg+(r-avg)*s;
      g=avg+(g-avg)*s;
      b=avg+(b-avg)*s;

      // clamp
      d[i]  = r<0?0:r>255?255:r;
      d[i+1]= g<0?0:g>255?255:g;
      d[i+2]= b<0?0:b>255?255:b;
      // d[i+3] alpha stays
    }
    ctx.putImageData(imgData,0,0);
  }

  function handleFile(f){
    const url=URL.createObjectURL(f);
    const img=new Image();
    img.onload=function(){
      original=img;
      draw(img);
      document.getElementById('saveBtn').disabled=false;
    };
    img.onerror=function(){
      alert('이미지를 불러오지 못했어요. JPG/PNG/WebP 파일인지 확인해 주세요.');
    };
    img.src=url;
  }

  // file inputs
  document.getElementById('file').addEventListener('change',e=>{
    if(e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
  });
  document.getElementById('fileDirect').addEventListener('change',e=>{
    if(e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
  });
  document.getElementById('openBtn').onclick=()=>document.getElementById('file').click();

  // presets
  document.querySelectorAll('.preset-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      if(!original) return;
      const f=btn.dataset.filter;
      if(f==='wes'){exp.value=10;contrast.value=20;satur.value=30;}
      if(f==='blade'){exp.value=-10;contrast.value=40;satur.value=-20;}
      if(f==='lala'){exp.value=5;contrast.value=15;satur.value=40;}
      if(f==='matrix'){exp.value=0;contrast.value=30;satur.value=-40;}
      if(f==='her'){exp.value=0;contrast.value=0;satur.value=20;}
      applyFilters();
    });
  });

  // sliders
  ['exp','contrast','satur'].forEach(id=>{
    document.getElementById(id).addEventListener('input',applyFilters);
  });

  // save
  document.getElementById('saveBtn').onclick=()=>{
    if(!original) return;
    const a=document.createElement('a');
    a.href=cv.toDataURL('image/jpeg',0.95);
    a.download='film-style-'+Date.now()+'.jpg';
    a.click();
  };
})();
</script>
</body>
</html>

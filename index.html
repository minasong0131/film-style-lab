<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Film Style Lab â€” Mobile (patched)</title>
  <meta name="theme-color" content="#111111" />
  <style>
    html,body{height:100%}body{margin:0;background:#f8fafc;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .bar{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:20;display:flex;align-items:center;padding:12px 16px}
    button{appearance:none;border:1px solid #111;background:#111;color:#fff;border-radius:8px;padding:8px 12px;font-weight:600;margin-left:6px}
    button.ghost{background:#fff;color:#111}
    button:disabled{opacity:.5}
    canvas{border:1px solid #e5e7eb;border-radius:8px;max-width:100%;height:auto}
  </style>
</head>
<body>
  <header class="bar">
    <strong style="font-size:16px">ğŸï¸ Film Style Lab</strong>
    <div style="margin-left:auto;display:flex;align-items:center">
      <input id="file" type="file" accept="image/*,.jpg,.jpeg,.png,.webp" capture="environment" style="display:none" />
      <button id="openBtn" class="ghost">ì‚¬ì§„ ì—´ê¸°</button>
      <button id="saveBtn" disabled>ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
  </header>

  <main class="container" style="padding:16px">
    <canvas id="cv"></canvas>
  </main>

<script>
(function(){
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  let currentImg = null;

  // ImageBitmapë„, HTMLImageElementë„ ëª¨ë‘ ì²˜ë¦¬
  function drawAny(src){
    const maxW = cv.parentElement.clientWidth;
    const w = src.naturalWidth || src.width;
    const h = src.naturalHeight || src.height;
    if(!w || !h){ console.warn('ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ì•Œ ìˆ˜ ì—†ìŒ'); return; }
    const scale = Math.min(1, maxW / w);
    cv.width = Math.round(w * scale);
    cv.height = Math.round(h * scale);
    ctx.drawImage(src, 0, 0, cv.width, cv.height);
  }

  // íŒŒì¼ ì—´ê¸° ë²„íŠ¼
  document.getElementById('openBtn').onclick=()=>{
    try{ document.getElementById('file').click(); }
    catch(e){ alert('íŒŒì¼ ì„ íƒì„ ì—´ ìˆ˜ ì—†ì–´ìš”. Chrome/Safariì—ì„œ ë‹¤ì‹œ ì—´ì–´ë³´ì„¸ìš”.'); }
  };

  // ì•ˆì „í•œ íŒŒì¼ ë¡œë” (HEIC ì•ˆë‚´ + createImageBitmap ìš°ì„ )
  document.getElementById('file').addEventListener('change', function(e){
    var files = e && e.target && e.target.files ? e.target.files : null;
    var f = files && files[0];
    if(!f){ console.warn('íŒŒì¼ ì„ íƒ ì•ˆ ë¨'); return; }

    var name = (f.name||'').toLowerCase();
    var type = (f.type||'').toLowerCase();

    if(!(type.indexOf('image/')===0) && !/(\.jpg|\.jpeg|\.png|\.webp)$/i.test(name)){
      alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒí•´ ì£¼ì„¸ìš” (JPG/PNG/WebP).');
      return;
    }
    if(/\.(heic|heif)$/i.test(name) || type.indexOf('heic')>-1 || type.indexOf('heif')>-1){
      alert('HEIC/HEIFëŠ” Chromeì—ì„œ ë°”ë¡œ ì—´ë¦¬ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”. JPG/PNG/WebPë¡œ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
      return;
    }

    if('createImageBitmap' in window){
      window.createImageBitmap(f).then(function(bm){
        currentImg = bm;
        drawAny(bm);
        document.getElementById('saveBtn').disabled = false;
      }).catch(function(err){
        console.warn('createImageBitmap ì‹¤íŒ¨, ObjectURL í´ë°± ì‚¬ìš©', err);
        var url = URL.createObjectURL(f);
        var img = new Image();
        img.onload = function(){ currentImg = img; drawAny(img); document.getElementById('saveBtn').disabled = false; URL.revokeObjectURL(url); };
        img.onerror = function(){ alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. JPG/PNG/WebP íŒŒì¼ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.'); URL.revokeObjectURL(url); };
        img.src = url;
      });
    } else {
      var url = URL.createObjectURL(f);
      var img = new Image();
      img.onload = function(){ currentImg = img; drawAny(img); document.getElementById('saveBtn').disabled = false; URL.revokeObjectURL(url); };
      img.onerror = function(){ alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. JPG/PNG/WebP íŒŒì¼ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.'); URL.revokeObjectURL(url); };
      img.src = url;
    }
  });

  // ì €ì¥
  document.getElementById('saveBtn').onclick=()=>{
    if(!currentImg) return;
    const a=document.createElement('a');
    a.href=cv.toDataURL('image/jpeg',0.95);
    a.download='film-style-'+Date.now()+'.jpg';
    a.click();
  };

  // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë‹¤ì‹œ ë§ì¶° ê·¸ë¦¬ê¸°
  window.addEventListener('resize',()=>{ if(currentImg) drawAny(currentImg); });
})();
</script>
</body>
</html>

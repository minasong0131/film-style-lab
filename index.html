<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Film Style Lab â€” Mobile (debug)</title>
  <meta name="theme-color" content="#111111" />
  <style>
    html,body{height:100%}body{margin:0;background:#f8fafc;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .bar{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:20;display:flex;align-items:center;padding:12px 16px}
    button{appearance:none;border:1px solid #111;background:#111;color:#fff;border-radius:8px;padding:8px 12px;font-weight:600;margin-left:6px}
    button.ghost{background:#fff;color:#111}
    button:disabled{opacity:.5}
    canvas{border:1px solid #e5e7eb;border-radius:8px;max-width:100%;height:auto}
    #preview{max-width:100%;height:auto;border:1px dashed #e5e7eb;border-radius:8px;margin-top:10px;display:none}
    .log{margin-top:10px;font-size:12px;color:#111;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px;white-space:pre-wrap}
  </style>
</head>
<body>
  <header class="bar">
    <strong style="font-size:16px">ğŸï¸ Film Style Lab</strong>
    <div style="margin-left:auto;display:flex;align-items:center">
      <input id="file" type="file" accept="image/*,.jpg,.jpeg,.png,.webp" capture="environment" style="display:none" />
      <button id="openBtn" class="ghost">ì‚¬ì§„ ì—´ê¸°</button>
      <button id="saveBtn" disabled>ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
  </header>

  <main class="container" style="padding:16px">
    <canvas id=\"cv\"></canvas>
    <img id=\"preview\" alt=\"ì›ë³¸ ë¯¸ë¦¬ë³´ê¸°\" />
    <div id=\"log\" class=\"log\"></div>
    <div id="log" style="margin-top:12px;font-size:12px;color:#555"></div>
  </main>

<script>
(function(){
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const $log = document.getElementById('log');
  const $preview = document.getElementById('preview');
  function log(msg){ try{ $log.textContent += (msg+'
'); }catch(e){} }
  if(!ctx){ alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œ 2D ìº”ë²„ìŠ¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ìš”. Chrome/Safari ìµœì‹  ë²„ì „ì„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.'); }
  const log = document.getElementById('log');
  let currentImg = null;

  function debug(msg){
    console.log(msg);
    log.innerHTML += `<div>${msg}</div>`;
  }

  function drawAny(src){
    try{
      const w = src.naturalWidth || src.width;
      const h = src.naturalHeight || src.height;
      if(!w || !h){ log('ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ì•Œ ìˆ˜ ì—†ìŒ'); return; }
      const maxW = cv.parentElement.clientWidth || window.innerWidth || w;
      const scale = Math.min(1, maxW/ w);
      cv.width = Math.round(w*scale);
      cv.height = Math.round(h*scale);
      ctx.clearRect(0,0,cv.width,cv.height);
      ctx.drawImage(src,0,0,cv.width,cv.height);
      log('ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸° ì™„ë£Œ: '+cv.width+'x'+cv.height);
    }catch(e){ log('drawAny ì˜¤ë¥˜: '+e.message); }
  }
    const maxW = cv.parentElement.clientWidth;
    const scale = Math.min(1, maxW/w);
    cv.width = w*scale;
    cv.height = h*scale;
    ctx.drawImage(src,0,0,cv.width,cv.height);
    debug(`ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° ì™„ë£Œ: ${w}x${h} â†’ ${cv.width}x${cv.height}`);
  }

  document.getElementById('openBtn').onclick=()=>{
    debug('íŒŒì¼ ì„ íƒ ì—´ê¸° í´ë¦­');
    document.getElementById('file').click();
  };

  document.getElementById('file').addEventListener('change', function(e){
    log('change ì´ë²¤íŠ¸');
    var files = e && e.target && e.target.files ? e.target.files : null;
    var f = files && files[0];
    if(!f){ log('íŒŒì¼ ì—†ìŒ'); return; }

    var name = (f.name||'').toLowerCase();
    var type = (f.type||'').toLowerCase();
    log('ì„ íƒ: '+name+' ('+type+'), '+(f.size||0)+' bytes');

    if(!(type.indexOf('image/')===0) && !/(\.jpg|\.jpeg|\.png|\.webp)$/i.test(name)){
      alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒí•´ ì£¼ì„¸ìš” (JPG/PNG/WebP).');
      log('ì´ë¯¸ì§€ ì•„ë‹˜: ì°¨ë‹¨');
      return;
    }
    if(/\.(heic|heif)$/i.test(name) || type.indexOf('heic')>-1 || type.indexOf('heif')>-1){
      alert('HEIC/HEIFëŠ” Chromeì—ì„œ ë°”ë¡œ ì—´ë¦¬ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”. JPG/PNG/WebPë¡œ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
      log('HEIC/HEIF ì°¨ë‹¨');
      return;
    }

    // ì›ë³¸ ë¯¸ë¦¬ë³´ê¸° (ë””ë²„ê·¸ìš©)
    try{
      var url = URL.createObjectURL(f);
      $preview.src = url; $preview.style.display='block';
      log('preview ì„¤ì • ì™„ë£Œ (ObjectURL)');
    }catch(e){ log('preview ì„¤ì • ì‹¤íŒ¨: '+e.message); }

    if('createImageBitmap' in window){
      window.createImageBitmap(f).then(function(bm){
        log('createImageBitmap ì„±ê³µ: '+bm.width+'x'+bm.height);
        currentImg = bm; drawAny(bm); document.getElementById('saveBtn').disabled = false;
      }).catch(function(err){
        log('createImageBitmap ì‹¤íŒ¨: '+err);
        var url2 = URL.createObjectURL(f);
        var img = new Image();
        img.onload = function(){ currentImg = img; drawAny(img); document.getElementById('saveBtn').disabled = false; URL.revokeObjectURL(url2); log('Image() ê²½ë¡œ ì„±ê³µ'); };
        img.onerror = function(){ alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. JPG/PNG/WebP íŒŒì¼ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.'); URL.revokeObjectURL(url2); log('Image() ê²½ë¡œ ì‹¤íŒ¨'); };
        img.src = url2;
      });
    } else {
      log('createImageBitmap ë¯¸ì§€ì› â†’ Image() ê²½ë¡œ ì‚¬ìš©');
      var url3 = URL.createObjectURL(f);
      var img2 = new Image();
      img2.onload = function(){ currentImg = img2; drawAny(img2); document.getElementById('saveBtn').disabled = false; URL.revokeObjectURL(url3); log('Image() ë¡œë“œ ì„±ê³µ'); };
      img2.onerror = function(){ alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. JPG/PNG/WebP íŒŒì¼ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.'); URL.revokeObjectURL(url3); log('Image() ë¡œë“œ ì‹¤íŒ¨'); };
      img2.src = url3;
    }
  }); return; }

    debug(`íŒŒì¼ ì„ íƒë¨: ${f.name}, type=${f.type}`);

    var name = (f.name||'').toLowerCase();
    var type = (f.type||'').toLowerCase();

    if(!(type.indexOf('image/')===0) && !/(\.jpg|\.jpeg|\.png|\.webp)$/i.test(name)){
      alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒí•´ ì£¼ì„¸ìš” (JPG/PNG/WebP).');
      return;
    }
    if(/\.(heic|heif)$/i.test(name) || type.indexOf('heic')>-1 || type.indexOf('heif')>-1){
      alert('HEIC/HEIFëŠ” Chromeì—ì„œ ë°”ë¡œ ì—´ë¦¬ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”. JPG/PNG/WebPë¡œ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.');
      return;
    }

    if('createImageBitmap' in window){
      debug('createImageBitmap ì‹œë„');
      window.createImageBitmap(f).then(function(bm){
        debug('createImageBitmap ì„±ê³µ');
        currentImg = bm; drawAny(bm); document.getElementById('saveBtn').disabled = false;
      }).catch(function(err){
        debug('createImageBitmap ì‹¤íŒ¨: '+err);
        var url = URL.createObjectURL(f);
        var img = new Image();
        img.onload = function(){ debug('Image() ë¡œë“œ ì„±ê³µ'); currentImg = img; drawAny(img); document.getElementById('saveBtn').disabled = false; URL.revokeObjectURL(url); };
        img.onerror = function(){ debug('Image() ë¡œë“œ ì‹¤íŒ¨'); alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. JPG/PNG/WebP íŒŒì¼ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.'); URL.revokeObjectURL(url); };
        img.src = url;
      });
    } else {
      debug('createImageBitmap ì—†ìŒ, ObjectURL ê²½ë¡œ ì‚¬ìš©');
      var url = URL.createObjectURL(f);
      var img = new Image();
      img.onload = function(){ debug('Image() ë¡œë“œ ì„±ê³µ'); currentImg = img; drawAny(img); document.getElementById('saveBtn').disabled = false; URL.revokeObjectURL(url); };
      img.onerror = function(){ debug('Image() ë¡œë“œ ì‹¤íŒ¨'); alert('ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”. JPG/PNG/WebP íŒŒì¼ì¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.'); URL.revokeObjectURL(url); };
      img.src = url;
    }
  });

  document.getElementById('saveBtn').onclick=()=>{
    if(!currentImg){ debug('ì €ì¥ ì‹œë„í–ˆì§€ë§Œ currentImg ì—†ìŒ'); return; }
    const a=document.createElement('a');
    a.href=cv.toDataURL('image/jpeg',0.95);
    a.download='film-style-'+Date.now()+'.jpg';
    a.click();
    debug('ì´ë¯¸ì§€ ì €ì¥ í´ë¦­');
  };

  window.addEventListener('resize',()=>{ if(currentImg) drawAny(currentImg); });
})();
</script>
</body>
</html>

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Film Style Lab ‚Äî Mobile (debug clean)</title>
  <meta name="theme-color" content="#111111" />
  <style>
    html,body{height:100%}
    body{margin:0;background:#f8fafc;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .bar{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:20;display:flex;align-items:center;padding:12px 16px}
    button{appearance:none;border:1px solid #111;background:#111;color:#fff;border-radius:8px;padding:8px 12px;font-weight:600;margin-left:6px}
    button.ghost{background:#fff;color:#111}
    button:disabled{opacity:.5}
    canvas{border:1px solid #e5e7eb;border-radius:8px;max-width:100%;height:auto}
    #preview{max-width:100%;height:auto;border:1px dashed #e5e7eb;border-radius:8px;margin-top:10px;display:none}
    #log{margin-top:10px;font-size:12px;color:#111;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px;white-space:pre-wrap}
  </style>
</head>
<body>
  <header class="bar">
    <strong style="font-size:16px">üéûÔ∏è Film Style Lab</strong>
    <div style="margin-left:auto;display:flex;align-items:center">
      <input id="file" type="file" accept="image/*,.jpg,.jpeg,.png,.webp" capture="environment" style="display:none" />
      <button id="openBtn" class="ghost">ÏÇ¨ÏßÑ Ïó¥Í∏∞</button>
      <button id="saveBtn" disabled>Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•</button>
    </div>
  </header>

  <main class="container" style="padding:16px">
    <canvas id="cv"></canvas>
    <img id="preview" alt="ÏõêÎ≥∏ ÎØ∏Î¶¨Î≥¥Í∏∞" />
    <div id="log"></div>
  </main>

<script>
(function(){
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const $log = document.getElementById('log');
  const $preview = document.getElementById('preview');
  let currentImg = null;

  function logMsg(msg){
    console.log(msg);
    if ($log) $log.textContent += msg + "\n";
  }

  if(!ctx){
    alert('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú 2D Ï∫îÎ≤ÑÏä§Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏñ¥Ïöî. Chrome/Safari ÏµúÏã† Î≤ÑÏ†ÑÏùÑ ÏÇ¨Ïö©Ìï¥ Ï£ºÏÑ∏Ïöî.');
    return;
  }

  function drawAny(src){
    try{
      const w = src.naturalWidth || src.width;
      const h = src.naturalHeight || src.height;
      if(!w || !h){ logMsg('Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Î•º Ïïå Ïàò ÏóÜÏùå'); return; }
      const maxW = cv.parentElement.clientWidth || window.innerWidth || w;
      const scale = Math.min(1, maxW / w);
      cv.width = Math.round(w * scale);
      cv.height = Math.round(h * scale);
      ctx.clearRect(0,0,cv.width,cv.height);
      ctx.drawImage(src, 0, 0, cv.width, cv.height);
      logMsg(`Ï∫îÎ≤ÑÏä§Ïóê Í∑∏Î¶¨Í∏∞ ÏôÑÎ£å: ${cv.width}x${cv.height}`);
    }catch(e){ logMsg('drawAny Ïò§Î•ò: ' + e.message); }
  }

  // ÌååÏùº Ïó¥Í∏∞ Î≤ÑÌäº
  document.getElementById('openBtn').onclick = () => {
    logMsg('ÌååÏùº ÏÑ†ÌÉù Ïó¥Í∏∞ ÌÅ¥Î¶≠');
    document.getElementById('file').click();
  };

  // ÌååÏùº ÏÑ†ÌÉù Ìï∏Îì§Îü¨ (HEIC ÏïàÎÇ¥ + createImageBitmap Ïö∞ÏÑ†)
  document.getElementById('file').addEventListener('change', function(e){
    logMsg('change Ïù¥Î≤§Ìä∏');
    const files = e && e.target && e.target.files ? e.target.files : null;
    const f = files && files[0];
    if(!f){ logMsg('ÌååÏùº ÏóÜÏùå'); return; }

    const name = (f.name||'').toLowerCase();
    const type = (f.type||'').toLowerCase();
    logMsg(`ÏÑ†ÌÉù: ${name} (${type}), ${(f.size||0)} bytes`);

    if(!(type.indexOf('image/')===0) && !/\.(jpg|jpeg|png|webp)$/i.test(name)){
      alert('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî (JPG/PNG/WebP).');
      logMsg('Ïù¥ÎØ∏ÏßÄ ÏïÑÎãò: Ï∞®Îã®');
      return;
    }
    if(/\.(heic|heif)$/i.test(name) || type.includes('heic') || type.includes('heif')){
      alert('HEIC/HEIFÎäî ChromeÏóêÏÑú Î∞îÎ°ú Ïó¥Î¶¨ÏßÄ ÏïäÏùÑ Ïàò ÏûàÏñ¥Ïöî. JPG/PNG/WebPÎ°ú ÏÇ¨Ïö©Ìï¥ Ï£ºÏÑ∏Ïöî.');
      logMsg('HEIC/HEIF Ï∞®Îã®');
      return;
    }

    // Ïç∏ÎÑ§Ïùº ÎØ∏Î¶¨Î≥¥Í∏∞
    try{
      const url = URL.createObjectURL(f);
      $preview.src = url; $preview.style.display='block';
      logMsg('preview ÏÑ§Ï†ï ÏôÑÎ£å (ObjectURL)');
    }catch(err){ logMsg('preview ÏÑ§Ï†ï Ïã§Ìå®: ' + err.message); }

    // ÎîîÏΩîÎî©
    if ('createImageBitmap' in window){
      createImageBitmap(f).then(bm=>{
        logMsg(`createImageBitmap ÏÑ±Í≥µ: ${bm.width}x${bm.height}`);
        currentImg = bm;
        drawAny(bm);
        document.getElementById('saveBtn').disabled = false;
      }).catch(err=>{
        logMsg('createImageBitmap Ïã§Ìå®: ' + err);
        const url2 = URL.createObjectURL(f);
        const img = new Image();
        img.onload = function(){
          currentImg = img; drawAny(img);
          document.getElementById('saveBtn').disabled = false;
          URL.revokeObjectURL(url2);
          logMsg('Image() Í≤ΩÎ°ú ÏÑ±Í≥µ');
        };
        img.onerror = function(){
          alert('Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏñ¥Ïöî. JPG/PNG/WebP ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.');
          URL.revokeObjectURL(url2);
          logMsg('Image() Í≤ΩÎ°ú Ïã§Ìå®');
        };
        img.src = url2;
      });
    } else {
      logMsg('createImageBitmap ÎØ∏ÏßÄÏõê ‚Üí Image() Í≤ΩÎ°ú ÏÇ¨Ïö©');
      const url3 = URL.createObjectURL(f);
      const img2 = new Image();
      img2.onload = function(){
        currentImg = img2; drawAny(img2);
        document.getElementById('saveBtn').disabled = false;
        URL.revokeObjectURL(url3);
        logMsg('Image() Î°úÎìú ÏÑ±Í≥µ');
      };
      img2.onerror = function(){
        alert('Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏñ¥Ïöî. JPG/PNG/WebP ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏Ìï¥ Ï£ºÏÑ∏Ïöî.');
        URL.revokeObjectURL(url3);
        logMsg('Image() Î°úÎìú Ïã§Ìå®');
      };
      img2.src = url3;
    }
  });

  // Ï†ÄÏû•
  document.getElementById('saveBtn').onclick = () => {
    if(!currentImg){ logMsg('Ï†ÄÏû• ÏãúÎèÑÌñàÏßÄÎßå currentImg ÏóÜÏùå'); return; }
    const a = document.createElement('a');
    a.href = cv.toDataURL('image/jpeg', 0.95);
    a.download = 'film-style-' + Date.now() + '.jpg';
    a.click();
    logMsg('Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû• ÌÅ¥Î¶≠');
  };

  // Î¶¨ÏÇ¨Ïù¥Ï¶à Ïãú Îã§Ïãú ÎßûÏ∂∞ Í∑∏Î¶¨Í∏∞
  window.addEventListener('resize', ()=>{ if(currentImg) drawAny(currentImg); });
})();
</script>
</body>
</html>

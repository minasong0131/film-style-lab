<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Film Style Lab — Mobile (patched)</title>
  <meta name="theme-color" content="#111111" />
  <style>
    html,body{height:100%}body{margin:0;background:#f8fafc;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .bar{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:20;display:flex;align-items:center;padding:12px 16px}
    button{appearance:none;border:1px solid #111;background:#111;color:#fff;border-radius:8px;padding:8px 12px;font-weight:600;margin-left:6px}
    button.ghost{background:#fff;color:#111}
    button:disabled{opacity:.5}
    canvas{border:1px solid #e5e7eb;border-radius:8px;max-width:100%;height:auto}
  </style>
</head>
<body>
  <header class="bar">
    <strong style="font-size:16px">🎞️ Film Style Lab</strong>
    <div style="margin-left:auto;display:flex;align-items:center">
      <input id="file" type="file" accept="image/*,.jpg,.jpeg,.png,.webp" capture="environment" style="display:none" />
      <button id="openBtn" class="ghost">사진 열기</button>
      <button id="saveBtn" disabled>이미지 저장</button>
    </div>
  </header>

  <main class="container" style="padding:16px">
    <canvas id="cv"></canvas>
  </main>

<script>
(function(){
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  let currentImg = null;

  // ImageBitmap도, HTMLImageElement도 모두 처리
  function drawAny(src){
    const maxW = cv.parentElement.clientWidth;
    const w = src.naturalWidth || src.width;
    const h = src.naturalHeight || src.height;
    if(!w || !h){ console.warn('이미지 크기를 알 수 없음'); return; }
    const scale = Math.min(1, maxW / w);
    cv.width = Math.round(w * scale);
    cv.height = Math.round(h * scale);
    ctx.drawImage(src, 0, 0, cv.width, cv.height);
  }

  // 파일 열기 버튼
  document.getElementById('openBtn').onclick=()=>{
    try{ document.getElementById('file').click(); }
    catch(e){ alert('파일 선택을 열 수 없어요. Chrome/Safari에서 다시 열어보세요.'); }
  };

  // 안전한 파일 로더 (HEIC 안내 + createImageBitmap 우선)
  document.getElementById('file').addEventListener('change', function(e){
    var files = e && e.target && e.target.files ? e.target.files : null;
    var f = files && files[0];
    if(!f){ console.warn('파일 선택 안 됨'); return; }

    var name = (f.name||'').toLowerCase();
    var type = (f.type||'').toLowerCase();

    if(!(type.indexOf('image/')===0) && !/(\.jpg|\.jpeg|\.png|\.webp)$/i.test(name)){
      alert('이미지 파일만 선택해 주세요 (JPG/PNG/WebP).');
      return;
    }
    if(/\.(heic|heif)$/i.test(name) || type.indexOf('heic')>-1 || type.indexOf('heif')>-1){
      alert('HEIC/HEIF는 Chrome에서 바로 열리지 않을 수 있어요. JPG/PNG/WebP로 사용해 주세요.');
      return;
    }

    if('createImageBitmap' in window){
      window.createImageBitmap(f).then(function(bm){
        currentImg = bm;
        drawAny(bm);
        document.getElementById('saveBtn').disabled = false;
      }).catch(function(err){
        console.warn('createImageBitmap 실패, ObjectURL 폴백 사용', err);
        var url = URL.createObjectURL(f);
        var img = new Image();
        img.onload = function(){ currentImg = img; drawAny(img); document.getElementById('saveBtn').disabled = false; URL.revokeObjectURL(url); };
        img.onerror = function(){ alert('이미지를 불러오지 못했어요. JPG/PNG/WebP 파일인지 확인해 주세요.'); URL.revokeObjectURL(url); };
        img.src = url;
      });
    } else {
      var url = URL.createObjectURL(f);
      var img = new Image();
      img.onload = function(){ currentImg = img; drawAny(img); document.getElementById('saveBtn').disabled = false; URL.revokeObjectURL(url); };
      img.onerror = function(){ alert('이미지를 불러오지 못했어요. JPG/PNG/WebP 파일인지 확인해 주세요.'); URL.revokeObjectURL(url); };
      img.src = url;
    }
  });

  // 저장
  document.getElementById('saveBtn').onclick=()=>{
    if(!currentImg) return;
    const a=document.createElement('a');
    a.href=cv.toDataURL('image/jpeg',0.95);
    a.download='film-style-'+Date.now()+'.jpg';
    a.click();
  };

  // 리사이즈 시 다시 맞춰 그리기
  window.addEventListener('resize',()=>{ if(currentImg) drawAny(currentImg); });
})();
</script>
</body>
</html>
